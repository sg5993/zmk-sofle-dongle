#define ZMK_POINTING_DEFAULT_MOVE_VAL 1200  // 600
#define ZMK_POINTING_DEFAULT_SCRL_VAL 35    // 10

#include <input/processors.dtsi>
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/pointing.h>
#include <dt-bindings/zmk/rgb.h>// ZMK 헤더 파일들 (기존과 동일)
#define ZMK_POINTING_DEFAULT_MOVE_VAL 1200
#define ZMK_POINTING_DEFAULT_SCRL_VAL 35

#include <input/processors.dtsi>
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/pointing.h>
#include <dt-bindings/zmk/rgb.h>

/ {
    // 기존 zip_scroll_scaler 정의 (동일)
    zip_scroll_scaler: zip_scroll_scaler {
        compatible = "zmk,input-processor-scaler";
        #input-processor-cells = <2>;
        type = <INPUT_EV_REL>;
        codes = <INPUT_REL_WHEEL INPUT_REL_HWHEEL>;
        track-remainders;
    };
};

// 기존 &mmv, &msc 리스너 및 설정 (동일)
&mmv_input_listener { input-processors = <&zip_xy_scaler 1 1>; };
&msc_input_listener { input-processors = <&zip_scroll_scaler 2 1>; };
&msc { acceleration-exponent = <2>; time-to-max-speed-ms = <100>; delay-ms = <0>; };
&mmv { time-to-max-speed-ms = <0>; acceleration-exponent = <2>; };

/ {
    // 기존 scroll_encoder, behaviors 정의 (동일)
    scroll_encoder: scroll_encoder {
        compatible = "zmk,behavior-sensor-rotate";
        #sensor-binding-cells = <0>;
        bindings = <&msc SCRL_DOWN>, <&msc SCRL_UP>;
        tap-ms = <30>;
    };
    behaviors {};

    // ====================================================================================
    // ===== 여기서부터 키맵 정의 시작 =====
    // ====================================================================================

    // ===== [변경점 1] 레이어 이름 정의 추가 =====
    #define BASE 0
    #define LAYER1 1
    #define LAYER2 2
    #define MOUSE_SLOW 3
    #define MOUSE_NORMAL 4
    #define MOUSE_FAST 5

    keymap {
        compatible = "zmk,keymap";

        // ===== 기존 layer0 (BASE) =====
        layer0 {
            bindings = <
                &kp ESC       &kp N1            &kp N2            &kp N3            &kp N4    &kp N5        &kp UP_ARROW      &kp N6      &kp N7    &kp N8          &kp N9          &kp N0          &kp BACKSPACE
                &kp TAB       &kp Q             &kp W             &kp E             &kp R     &kp T         &kp DOWN_ARROW    &kp Y       &kp U     &kp I           &kp O           &kp P           &kp DELETE
                &kp BACKSPACE &kp A             &kp S             &kp D             &kp F     &kp G         &kp LEFT_ARROW    &kp H       &kp J     &kp K           &kp L           &kp SEMI        &kp ENTER
                &kp LSHFT     &kp Z             &kp X             &kp C             &kp V     &kp B         &kp RIGHT_ARROW   &kp N       &kp M     &kp COMMA       &kp DOT         &kp FSLH        &kp RIGHT_SHIFT
                // ===== [변경점 2] &mo 2를 &to MOUSE_NORMAL로 변경하여 마우스 모드로 진입 =====
                &kp C_MUTE    &kp LEFT_WIN      &kp LEFT_CONTROL  &kp LEFT_ALT      &mo LAYER1 &kp SPACE    &kp ENTER         &kp SPACE   &to MOUSE_NORMAL &kp RIGHT_ALT &kp RIGHT_SHIFT &kp DELETE
            >;
            sensor-bindings = <&inc_dec_kp C_VOLUME_UP C_VOL_DN>;
            display-name = "BASE";
        };

        // ===== 기존 layer_1 (LAYER1) =====
        layer_1 {
            // 기존 layer_1의 마우스 기능을 제거하고 다른 기능키 위주로 정리했습니다.
            bindings = <
                &kp GRAVE         &kp F1            &kp F2            &kp F3            &kp F4            &kp F5              &trans         &kp F6        &kp F7        &kp F8          &kp LEFT_PARENTHESIS  &kp RIGHT_PARENTHESIS &kp F11
                &trans            &bt BT_SEL 0      &bt BT_SEL 1      &bt BT_SEL 2      &bt BT_SEL 3      &bt BT_SEL 4        &trans         &kp COLON     &kp EQUAL     &kp PLUS        &kp LEFT_BRACKET      &kp RIGHT_BRACKET     &kp F12
                &trans            &kp TILDE         &trans            &trans            &trans            &trans              &trans         &kp SEMICOLON &kp MINUS     &kp UNDERSCORE  &kp DOUBLE_QUOTES     &kp SINGLE_QUOTE      &kp F9
                &sk LEFT_CONTROL  &rgb_ug RGB_OFF   &rgb_ug RGB_ON    &rgb_ug RGB_EFF   &rgb_ug RGB_EFR   &rgb_ug RGB_SPI     &trans         &kp SLASH     &kp BACKSLASH &kp PIPE        &kp LEFT_BRACE        &kp RIGHT_BRACE       &kp F10
                &kp C_MUTE        &bt BT_CLR        &bt BT_CLR_ALL    &trans            &trans            &trans              &trans         &trans        &trans        &trans          &trans                &trans                &trans
            >;
            display-name = "LAYER1";
            sensor-bindings = <&scroll_encoder>;
        };

        // ===== 기존 layer_2 (LAYER2) =====
        layer_2 {
            // layer_2는 마우스 기능을 모두 제거하고 다른 기능들을 그대로 두었습니다.
            bindings = <
                &kp TILDE         &kp F1            &kp F2            &kp F3            &kp F4            &kp F5              &trans         &kp F6        &kp F7          &kp F8            &kp F9            &kp F10           &kp F11
                &trans            &bt BT_SEL 0      &bt BT_SEL 1      &bt BT_SEL 2      &bt BT_SEL 3      &bt BT_SEL 4        &trans         &trans        &trans          &trans            &trans            &trans            &kp F12
                &trans            &out OUT_USB      &out OUT_BLE      &trans            &trans            &trans              &trans         &trans        &trans          &trans            &trans            &trans            &kp RBRC
                &sk LEFT_CONTROL  &sys_reset        &trans            &bootloader       &trans            &trans              &trans         &trans        &trans          &trans            &trans            &trans            &trans
                &trans            &bt BT_CLR        &bt BT_CLR_ALL    &trans            &trans            &trans              &trans         &trans        &trans          &trans            &trans            &trans            &trans
            >;
            sensor-bindings = <&scroll_encoder>;
        };

        // ====================================================================================
        // ===== [변경점 3] 새로운 마우스 전용 레이어 3개 추가 =====
        // ====================================================================================

        /* 3번: 마우스 느린 속도 레이어 */
        mouse_slow_layer {
            bindings = <
                &trans  &trans            &trans            &trans            &trans    &trans              // --- 마우스 이동 (느림) ---
                &mmv MOVE_UP 2 1  &trans    &trans    &trans          &trans          &trans          &trans
                &trans  // --- 속도 조절 ---
                        &to MOUSE_SLOW    &to MOUSE_NORMAL  &to MOUSE_FAST    &trans    &trans              // --- 마우스 이동 (느림) ---
                &mmv MOVE_DOWN 2 1 &trans    &trans    &trans          &trans          &trans          &trans
                &trans  &trans            &trans            &trans            &trans    &trans              // --- 마우스 이동 (느림) ---
                &mmv MOVE_LEFT 2 1 &trans    &trans    &trans          &trans          &trans          &trans
                &trans  &trans            &trans            &trans            &trans    &trans              // --- 마우스 이동 (느림) ---
                &mmv MOVE_RIGHT 2 1&trans    &trans    &trans          &trans          &trans          &trans
                &trans  &trans            // --- 마우스 클릭 ---
                                          &mkp LCLK         &mkp RCLK         // --- 기본 레이어 복귀 ---
                                                                                &to BASE  &mkp MCLK   &trans    &trans          &trans          &trans          &trans
            >;
            display-name = "MOUSE SLOW";
            sensor-bindings = <&scroll_encoder>;
        };

        /* 4번: 마우스 보통 속도 레이어 */
        mouse_normal_layer {
            bindings = <
                &trans  &trans            &trans            &trans            &trans    &trans              // --- 마우스 이동 (보통) ---
                &mmv MOVE_UP 6 1  &trans    &trans    &trans          &trans          &trans          &trans
                &trans  // --- 속도 조절 ---
                        &to MOUSE_SLOW    &to MOUSE_NORMAL  &to MOUSE_FAST    &trans    &trans              // --- 마우스 이동 (보통) ---
                &mmv MOVE_DOWN 6 1 &trans    &trans    &trans          &trans          &trans          &trans
                &trans  &trans            &trans            &trans            &trans    &trans              // --- 마우스 이동 (보통) ---
                &mmv MOVE_LEFT 6 1 &trans    &trans    &trans          &trans          &trans          &trans
                &trans  &trans            &trans            &trans            &trans    &trans              // --- 마우스 이동 (보통) ---
                &mmv MOVE_RIGHT 6 1&trans    &trans    &trans          &trans          &trans          &trans
                &trans  &trans            // --- 마우스 클릭 ---
                                          &mkp LCLK         &mkp RCLK         // --- 기본 레이어 복귀 ---
                                                                                &to BASE  &mkp MCLK   &trans    &trans          &trans          &trans          &trans
            >;
            display-name = "MOUSE NORMAL";
            sensor-bindings = <&scroll_encoder>;
        };

        /* 5번: 마우스 빠른 속도 레이어 */
        mouse_fast_layer {
            bindings = <
                &trans  &trans            &trans            &trans            &trans    &trans              // --- 마우스 이동 (빠름) ---
                &mmv MOVE_UP 10 1 &trans    &trans    &trans          &trans          &trans          &trans
                &trans  // --- 속도 조절 ---
                        &to MOUSE_SLOW    &to MOUSE_NORMAL  &to MOUSE_FAST    &trans    &trans              // --- 마우스 이동 (빠름) ---
                &mmv MOVE_DOWN 10 1&trans    &trans    &trans          &trans          &trans          &trans
                &trans  &trans            &trans            &trans            &trans    &trans              // --- 마우스 이동 (빠름) ---
                &mmv MOVE_LEFT 10 1&trans    &trans    &trans          &trans          &trans          &trans
                &trans  &trans            &trans            &trans            &trans    &trans              // --- 마우스 이동 (빠름) ---
                &mmv MOVE_RIGHT 10 1&trans    &trans    &trans          &trans          &trans          &trans
                &trans  &trans            // --- 마우스 클릭 ---
                                          &mkp LCLK         &mkp RCLK         // --- 기본 레이어 복귀 ---
                                                                                &to BASE  &mkp MCLK   &trans    &trans          &trans          &trans          &trans
            >;
            display-name = "MOUSE FAST";
            sensor-bindings = <&scroll_encoder>;
        };
    };
};

/ {
    zip_scroll_scaler: zip_scroll_scaler {
        compatible = "zmk,input-processor-scaler";
        #input-processor-cells = <2>;
        type = <INPUT_EV_REL>;
        codes = <INPUT_REL_WHEEL INPUT_REL_HWHEEL>;
        track-remainders;
    };
};

&mmv_input_listener { input-processors = <&zip_xy_scaler 1 1>; };

&msc_input_listener { input-processors = <&zip_scroll_scaler 2 1>; };

&msc {
    acceleration-exponent = <2>;      // 0
    time-to-max-speed-ms = <100>;       // 300
    delay-ms = <0>;                   // 0
};

&mmv {
    time-to-max-speed-ms = <0>;
    acceleration-exponent = <2>;
};

/ {
    scroll_encoder: scroll_encoder {
        compatible = "zmk,behavior-sensor-rotate";
        #sensor-binding-cells = <0>;
        bindings = <&msc SCRL_DOWN>, <&msc SCRL_UP>;

        tap-ms = <30>;
    };

    behaviors {
    };

    keymap {
        compatible = "zmk,keymap";

        layer0 {
            bindings = <
&kp ESC        &kp N1        &kp N2            &kp N3        &kp N4  &kp N5       &kp UP_ARROW     &kp N6     &kp N7  &kp N8         &kp N9           &kp N0      &kp BACKSPACE
&kp TAB        &kp Q         &kp W             &kp E         &kp R   &kp T        &kp DOWN_ARROW   &kp Y      &kp U   &kp I          &kp O            &kp P       &kp DELETE
&kp BACKSPACE  &kp A         &kp S             &kp D         &kp F   &kp G        &kp LEFT_ARROW   &kp H      &kp J   &kp K          &kp L            &kp SEMI    &kp ENTER
&kp LSHFT      &kp Z         &kp X             &kp C         &kp V   &kp B        &kp RIGHT_ARROW  &kp N      &kp M   &kp COMMA      &kp DOT          &kp FSLH    &kp RIGHT_SHIFT
&kp C_MUTE     &kp LEFT_WIN  &kp LEFT_CONTROL  &kp LEFT_ALT  &mo 1   &kp SPACE    &kp ENTER        &kp SPACE  &mo 2   &kp RIGHT_ALT  &kp RIGHT_SHIFT  &kp DELETE
            >;

            sensor-bindings = <&inc_dec_kp C_VOLUME_UP C_VOL_DN>;
            display-name = "LAYER0";
        };

        layer_1 {
            bindings = <
&kp GRAVE         &kp F1           &kp F2          &kp F3           &kp F4           &kp F5             &mmv MOVE_UP     &kp F6         &kp F7         &kp F8          &kp LEFT_PARENTHESIS  &kp RIGHT_PARENTHESIS  &kp F11
&trans            &bt BT_SEL 0     &bt BT_SEL 1    &bt BT_SEL 2     &bt BT_SEL 3     &bt BT_SEL 4       &mmv MOVE_DOWN   &kp COLON      &kp EQUAL      &kp PLUS        &kp LEFT_BRACKET      &kp RIGHT_BRACKET      &kp F12
&trans            &kp TILDE        &trans          &trans           &trans           &mkp MB5           &mmv MOVE_LEFT   &kp SEMICOLON  &kp MINUS      &kp UNDERSCORE  &kp DOUBLE_QUOTES     &kp SINGLE_QUOTE       &kp F9
&sk LEFT_CONTROL  &rgb_ug RGB_OFF  &rgb_ug RGB_ON  &rgb_ug RGB_EFF  &rgb_ug RGB_EFR  &rgb_ug RGB_SPI    &mmv MOVE_RIGHT  &kp SLASH      &kp BACKSLASH  &kp PIPE        &kp LEFT_BRACE        &kp RIGHT_BRACE        &kp F10
&kp C_MUTE        &bt BT_CLR       &bt BT_CLR_ALL  &trans           &trans           &trans             &mkp LCLK        &trans         &trans         &trans          &trans                &trans
            >;

            display-name = "layer1";
            sensor-bindings = <&scroll_encoder>;
        };

        layer_2 {
            bindings = <
&kp TILDE         &kp F1        &kp F2          &kp F3        &kp F4        &kp F5          &mmv MOVE_UP     &kp F6  &kp F7          &kp F8          &kp F9           &kp F10          &kp F11
&trans            &bt BT_SEL 0  &bt BT_SEL 1    &bt BT_SEL 2  &bt BT_SEL 3  &bt BT_SEL 4    &mmv MOVE_DOWN   &trans  &mkp LCLK       &mmv MOVE_UP    &mkp RCLK        &msc SCRL_UP     &kp F12
&trans            &out OUT_USB  &out OUT_BLE    &trans        &trans        &trans          &mmv MOVE_LEFT   &trans  &mmv MOVE_LEFT  &mmv MOVE_DOWN  &mmv MOVE_RIGHT  &msc SCRL_DOWN   &kp RBRC
&sk LEFT_CONTROL  &sys_reset    &trans          &bootloader   &trans        &trans          &mmv MOVE_RIGHT  &trans  &mkp MCLK       &trans          &msc SCRL_LEFT   &msc SCRL_RIGHT  &mkp LCLK
&trans            &bt BT_CLR    &bt BT_CLR_ALL  &trans        &trans        &trans          &mkp LCLK        &trans  &trans          &trans          &trans           &trans
            >;

            sensor-bindings = <&scroll_encoder>;
        };
    };
};
